<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Link Checker Report</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/5.5.2/css/tabulator.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/5.5.2/js/tabulator.min.js"></script>
    <!-- Add React and ReactDOM scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <!-- Add Babel for JSX support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Azeret+Mono:ital,wght@0,100..900;1,100..900&family=Inter+Tight:ital,wght@0,100..900;1,100..900&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: Roboto, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative; /* Add this for positioning the logo */
        }
        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .logo {
            position: absolute;
            top: 30px;
            right: 30px;
            width: 90px; /* Adjust to match h1 size */
            height: 90px;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .report-date {
            color: #666;
            margin-bottom: 20px;
        }
        #linkTable {
            margin-top: 20px;
            background-color: white;
        }
        .tab-buttons {
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 10px 20px;
            margin-right: 10px;
            border: none;
            border-radius: 4px;
            background-color: #e0e0e0;
            cursor: pointer;
        }
        .tab-button.active {
            background-color: #005C84;
            color: white;
        }
        .search-container {
            margin-bottom: 15px;
        }
        #searchInput {
            width: 50%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
        <h1>Test Link Checker Report</h1>
        <img src="black-stag.svg" alt="Black Stag Logo" class="logo">
        </div>
        <div class="report-date">Report generated: <span id="reportDate"></span></div>
        <p>
        This page can display two tables by clicking on the tabs: <strong>All links</strong> and <strong>Broken links (404)</strong>. 
            <ul>
                <li>All links is the table that includes both working and broken links.</li>
                <li>Broken links (404) is the table that includes only broken links.</li>
                <li>The link checker ignores links to downloadable files, emails, and recurses to a depth of 3. <strong>Don't expect it to catch everything.</strong></li>
            </ul>

        The table is sorted by the URL, Status Code, and Page Found On columns.
        <ul>
            <li><strong>URL</strong> is the URL of the checked link.</li>
            <li><strong>Status Code</strong> is the HTTP status code of the checked link.</li>
            <li><strong>Status Emoji</strong> is a visual indicator of the status code: ðŸ’™ for 200 OK, ðŸ’” for 404 broken, ðŸ˜• for any other status.</li>
            <li><strong>Page Found On</strong> is the webpage on which the link occurs.</li>
        </ul>

        You can filter the table using the search box and download either the filtered or unfiltered data as a CSV file.
        </p>
        
        <div class="tab-buttons">
            <button class="tab-button" onclick="loadData('all')">All Links</button>
            <button class="tab-button active" onclick="loadData('404')">Broken Links (404)</button>      
        </div>
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search in table...">
            <div id="csvExportContainer"></div> 
        </div>

        <div id="linkTable"></div>
    </div>

    <script>
        // Initialize table with link formatters
        let table = new Tabulator("#linkTable", {
            height: "700px",
            layout: "fitColumns",
            pagination: true,
            paginationSize: 25,
            columns: [
                {
                    title: "URL", 
                    field: "URL", 
                    sorter: "string", 
                    width: 300,
                    formatter: function(cell) {
                        const value = cell.getValue();
                        return value ? `<a href="${value}" target="_blank">${value}</a>` : '';
                    }
                },
                {title: "Status", field: "Status Code", sorter: "string", width: 100},
                {
                    title: "Status Emoji",
                    field: "Status Code",
                    width: 150,
                    formatter: function(cell) {
                        const statusCode = cell.getValue();
                        if (statusCode === '200') {
                            return 'ðŸ’™'; // Blue heart for 200 OK
                        } else if (statusCode === '404') {
                            return 'ðŸ’”'; // Broken heart for 404 Not Found
                        } else {
                            return 'ðŸ˜•'; // Confused face for any other status
                        }
                    }
                },
                {
                    title: "Page Found On", 
                    field: "Parent URL", 
                    sorter: "string",
                    formatter: function(cell) {
                        const value = cell.getValue();
                        return value ? `<a href="${value}" target="_blank">${value}</a>` : '';
                    }
                } 
            ]
        });

        // Set current date
        document.getElementById("reportDate").textContent = new Date().toLocaleDateString();

        document.getElementById('searchInput').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            table.setFilter(row => {
                return (
                    row.URL.toLowerCase().includes(searchTerm) ||
                    row['Parent URL'].toLowerCase().includes(searchTerm) ||
                    row['Status Code'].toLowerCase().includes(searchTerm)
                );
            });
        });

        // Load data function
        async function loadData(type) {
            // Update active button
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Activate the correct button
            const activeButton = document.querySelector(`.tab-button[onclick="loadData('${type}')"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }

            // Load appropriate CSV file
            const fileName = type === '404' ? 'broken_links.csv' : 'all_links.csv';
            try {
                const response = await fetch(fileName);
                const csvText = await response.text();
                const data = parseCSV(csvText);
                table.setData(data);
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Advanced CSV parser
        function parseCSV(csv) {
            const lines = csv.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            
            return lines.slice(1).filter(line => line.trim()).map(line => {
                const values = [];
                let currentValue = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"' && line[i+1] === '"') {
                        currentValue += '"';
                        i++;
                    } else if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(currentValue.trim());
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                
                // Add the last value
                values.push(currentValue.trim());
                
                // Map values to headers
                return headers.reduce((obj, header, i) => {
                    // Remove surrounding quotes if present
                    let value = values[i];
                    if (value && value.startsWith('"') && value.endsWith('"')) {
                        value = value.slice(1, -1);
                    }
                    obj[header] = value;
                    return obj;
                }, {});
            });
        }

        // Load broken links when page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadData('404');
        });

    </script>

    <!-- Add the CSV Export Component code -->
    <script type="text/babel">
        // First, create a simplified version of the UI button component since we don't have access to shadcn
        const Button = ({ children, onClick, className }) => {
            return (
                <button 
                    onClick={onClick}
                    className={`px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 ${className}`}
                >
                    {children}
                </button>
            );
        };

        // Add the Download icon component
        const Download = ({ className }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width="24" 
                height="24" 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round"
                className={className}
            >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="7 10 12 15 17 10" />
                <line x1="12" y1="15" x2="12" y2="3" />
            </svg>
        );

        // Add the CSVExportButton component code here
        const CSVExportButton = ({ tableId = 'linkTable' }) => {
            const exportToCSV = () => {
                // Use Tabulator's built-in export method
                const tabulatorTable = Tabulator.findTable(`#${tableId}`)[0];
                
                if (!tabulatorTable) {
                    console.error('Tabulator table not found');
                    return;
                }
            
                const today = new Date();
                const date = today.toISOString().split('T')[0];
                
                tabulatorTable.download("csv", `link-checker-report-${date}.csv`);
            };
        
            return (
                <Button 
                    onClick={exportToCSV}
                    className="flex items-center gap-2"
                >
                    <Download className="w-4 h-4" />
                    Export to CSV
                </Button>
            );
        };

        // Render the component
        ReactDOM.render(
            <CSVExportButton />,
            document.getElementById('csvExportContainer')
        );
    </script>
</body>
</html>
